"use client";

import { useRouter } from "next/navigation";
import { useState } from "react";

export default function SyncGmailButton() {
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  async function handleSync() {
    try {
      setLoading(true);

      const res = await fetch("/api/gmail/ingest?force=1", {
        method: "POST",
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        const reason = data.reason ? ` — ${data.reason}` : "";
        alert(`Sync failed: ${data.error || data.message || `HTTP ${res.status}`}${reason}`);
        return;
      }

      const scanned = Number(data.scanned ?? 0);
      const created = Number(data.created ?? 0);
      const updated = Number(data.updated ?? 0);
      const skipped = Math.max(0, scanned - created - updated);
      alert(`Gmail synced!\nScanned: ${scanned}\nCreated: ${created}\nUpdated: ${updated}\nSkipped: ${skipped}`);

      router.refresh(); 
    } catch (err: any) {
      alert(`Unexpected error: ${err?.message ?? err}`);
    } finally {
      setLoading(false);
    }
  }

  return (
    <button
      onClick={handleSync}
      disabled={loading}
      className="border border-gray-500 px-3 py-1 rounded-md hover:bg-gray-800"
    >
      {loading ? "Syncing…" : "Sync Gmail now"}
    </button>
  );
}

